import pandas as pd
from sklearn.preprocessing import MultiLabelBinarizer
from sklearn.metrics import f1_score, accuracy_score

# ===== 1. Load data =====
file_path = "sentiment coding.xlsx"   # ‚Üê Change to your file path
df = pd.read_excel(file_path)
df.columns = df.columns.str.strip()

# ===== 2. Label cleaning and parsing =====
def parse_labels(cell):
    """
    Parse cell into multi-label list:
    - Handle Excel _x000D_ newline characters
    - Split by newlines
    - Remove spaces and convert to lowercase
    """
    if pd.isna(cell):
        return []
    cell = str(cell).replace("_x000D_", "")
    labels = [l.strip().lower() for l in cell.splitlines() if l.strip()]
    return labels

# ===== 3. Parse four columns =====
human_labels = df["Overlap"].apply(parse_labels)
v3_labels = df["DeepSeek V3.2"].apply(parse_labels)
r1_labels = df["DeepSeek R1-7B"].apply(parse_labels)
bert_labels = df["BERT"].apply(parse_labels)

# ===== 4. MultiLabelBinarizer (using Overlap as reference) =====
mlb = MultiLabelBinarizer()
Y_human = mlb.fit_transform(human_labels)

Y_v3 = mlb.transform(v3_labels)
Y_r1 = mlb.transform(r1_labels)
Y_bert = mlb.transform(bert_labels)

# ===== 5. Evaluation function =====
def evaluate(y_true, y_pred, model_name):
    micro_f1 = f1_score(y_true, y_pred, average="micro")
    macro_f1 = f1_score(y_true, y_pred, average="macro")
    accuracy = accuracy_score(y_true, y_pred)  # subset accuracy
